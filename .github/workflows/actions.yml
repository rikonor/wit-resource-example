name: builders
on: [push]

jobs:
  linux-kernel-builder:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build image
        run: |
          docker buildx create \
            --use \
            --name builder \
            --platform linux/amd64 \
            --driver docker-container

          docker buildx build \
            -f Dockerfile.linux-kernel \
            -t orricon/test:${{ github.sha }} \
            --platform linux/amd64 \
            --build-arg SOURCE_DATE_EPOCH=0 \
            --output type=docker,dest=archive.tar,rewrite-timestamp=true \
                .

          docker load -i archive.tar

      - name: Login to container registry
        run: |
          docker login \
            -u 'orricon' \
            -p 'dckr_pat_Xoa1eSF5okEbaNQ4hJ7YcVdPWWw'
      
      - name: Publish docker image
        run: docker push orricon/test:${{ github.sha }}
